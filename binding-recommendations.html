<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-adsense-account" content="ca-pub-9206573130293174">
    <link rel="icon" href="asset/logo.png">
    <title>결속추천</title>
    <style>
        .familiar-image {
            width: 55px;
            margin: 5px;
            cursor: pointer;
        }
        .selected {
            border: 5px solid red;
        }
        #result {
            margin-top: 20px;
        }
    </style>
</head>
<body>

<h1>결속추천</h1>

<button id="guardian-button">수호</button>
<button id="transform-button">변신</button>

<div id="familiar-list"></div>

<p id="selected-count">선택된 환수: 0/40</p>
<button id="calculate-button">최적 조합 계산</button>

<div id="result"></div>

<script>
    let familiars = [];  // 전체 환수 데이터
    let selectedFamiliars = [];  // 사용자가 선택한 환수 (최대 40개)

    // JSON 데이터 로드
    fetch('linked_data.json')
        .then(response => response.json())
        .then(data => {
            familiars = data;
            console.log("데이터 로드 완료:", familiars);
            displayFamiliars("수호");  // 기본값은 수호 환수
        })
        .catch(error => {
            console.error("데이터 로드 실패:", error);
            alert("환수 데이터를 로드할 수 없습니다.");
        });

    // 환수 목록 표시
    function displayFamiliars(type) {
        const familiarList = document.getElementById('familiar-list');
        familiarList.innerHTML = '';

        familiars.filter(f => f.type === type).forEach(familiar => {
            let img = document.createElement('img');
            img.src = `images/ic_${familiar.ic}.jpg`; // 이미지 경로에 맞게 수정
            img.alt = familiar.name;
            img.classList.add('familiar-image');
            img.title = `${familiar.name} (${familiar.grade})`;
            img.addEventListener('click', () => selectFamiliar(familiar, img));
            familiarList.appendChild(img);
        });
    }

    // 환수 선택 기능
    function selectFamiliar(familiar, img) {
        if (selectedFamiliars.includes(familiar)) {
            selectedFamiliars = selectedFamiliars.filter(f => f !== familiar);
            img.classList.remove('selected');
        } else {
            if (selectedFamiliars.length < 40) {
                selectedFamiliars.push(familiar);
                img.classList.add('selected');
            } else {
                alert("최대 40개의 환수만 선택할 수 있습니다!");
            }
        }
        document.getElementById('selected-count').innerText = `선택된 환수: ${selectedFamiliars.length}/40`;
    }

    // 수호/변신 버튼 클릭 이벤트
    document.getElementById('guardian-button').addEventListener('click', () => displayFamiliars("수호"));
    document.getElementById('transform-button').addEventListener('click', () => displayFamiliars("변신"));

    // 등급세트 효과 계산
    function calculateScore(familiarCombination) {
    let totalPenetration = 0;
    let totalResistance = 0;
    let totalDamageReduction = 0;
    let totalDamageIncrease = 0;
    let gradeSetEffects = { "수호": { "전설": 0, "불멸": 0 }, "변신": { "전설": 0, "불멸": 0 } };

    familiarCombination.forEach(familiar => {
        const { option, grade, type } = familiar;
        totalPenetration += option['피해저항관통'] || 0;
        totalResistance += option['피해저항'] || 0;
        totalDamageReduction += option['대인방어%'] || 0;
        totalDamageIncrease += option['대인피해%'] || 0;

        // 등급 세트 효과 계산 (수호, 변신 별도 처리)
        if (type === '수호' || type === '변신') {
            gradeSetEffects[type][grade] += 1;

            if (grade === '전설') {
                if (gradeSetEffects[type]["전설"] === 4) totalPenetration += 100;
                if (gradeSetEffects[type]["전설"] === 6) {
                    totalPenetration += 100;
                    totalResistance += 100;
                }
            } else if (grade === '불멸') {
                if (type === '수호') {
                    if (gradeSetEffects["수호"]["불멸"] === 2) totalPenetration += 200;
                    if (gradeSetEffects["수호"]["불멸"] >= 3) {
                        totalPenetration += 200;
                        totalResistance += 150;
                    }
                    if (gradeSetEffects["수호"]["불멸"] >= 5) totalDamageIncrease += 20;
                    if (gradeSetEffects["수호"]["불멸"] === 6) totalDamageReduction += 20;
                } else if (type === '변신') {
                    if (gradeSetEffects["변신"]["불멸"] === 2) totalPenetration += 150;
                    if (gradeSetEffects["변신"]["불멸"] >= 3) {
                        totalPenetration += 150;
                        totalResistance += 150;
                    }
                    if (gradeSetEffects["변신"]["불멸"] >= 5) totalDamageIncrease += 20;
                    if (gradeSetEffects["변신"]["불멸"] === 6) totalDamageReduction += 20;
                }
            }
        }
    });

    return { totalPenetration, totalResistance, totalDamageReduction, totalDamageIncrease };
}


    // 세력 세트 효과 계산 (수호/변신 차이 반영)
    function calculateInfluenceSetEffects(familiarCombination, type) {
        let totalPenetration = 0;
        let totalResistance = 0;

        // 세력별 효과 적용
        let influenceSetEffects = {};

        familiarCombination.forEach(familiar => {
            const { influence } = familiar;
            influenceSetEffects[influence] = (influenceSetEffects[influence] || 0) + 1;
        });

        // 세력 세트 효과 적용 (수호와 변신 차이 반영)
        for (let influence in influenceSetEffects) {
            const count = influenceSetEffects[influence];

            if (type === '수호') {
                // 수호 타입
                if (influence === '결의' || influence === '고요' || influence === '의지') {
                    if (count >= 2) totalResistance += 50;
                    if (count >= 3) totalResistance += 80;
                    if (count >= 4) totalResistance += 130;
                    if (count >= 5) totalResistance += 150;
                    if (count === 6) totalResistance += 200;
                }
                if (influence === '침착' || influence === '냉정' || influence === '활력') {
                    if (count >= 2) totalPenetration += 30;
                    if (count >= 3) totalPenetration += 50;
                    if (count >= 4) totalPenetration += 80;
                    if (count >= 5) totalPenetration += 90;
                    if (count === 6) totalPenetration += 130;
                }
            
            } else if (type === '변신') {
                // 변신 타입
                if (influence === '결의' || influence === '고요' || influence === '냉정') {
                    if (count >= 2) totalPenetration += 30;
                    if (count >= 3) totalPenetration += 50;
                    if (count >= 4) totalPenetration += 80;
                    if (count >= 5) totalPenetration += 90;
                    if (count === 6) totalPenetration += 130;
                }
                if (influence === '활력' || influence === '침착' || influence === '의지') {
                    if (count >= 2) totalResistance += 50;
                    if (count >= 3) totalResistance += 80;
                    if (count >= 4) totalResistance += 130;
                    if (count >= 5) totalResistance += 150;
                    if (count === 6) totalResistance += 200;
                }
            }
        }

        return { totalPenetration, totalResistance };
    }

    // 최적의 점수 조합을 찾아서 출력
    document.getElementById('calculate-button').addEventListener('click', () => {
        if (selectedFamiliars.length < 6) {
            alert("최소 6개의 환수를 선택해야 합니다.");
            return;
        }

        let maxScore = 0;
        let bestCombination = [];

        // 6개 선택한 환수들 중 모든 조합을 계산
        for (let i = 0; i < selectedFamiliars.length - 5; i++) {
            for (let j = i + 1; j < selectedFamiliars.length - 4; j++) {
                for (let k = j + 1; k < selectedFamiliars.length - 3; k++) {
                    for (let l = k + 1; l < selectedFamiliars.length - 2; l++) {
                        for (let m = l + 1; m < selectedFamiliars.length - 1; m++) {
                            for (let n = m + 1; n < selectedFamiliars.length; n++) {
                                let combination = [
                                    selectedFamiliars[i],
                                    selectedFamiliars[j],
                                    selectedFamiliars[k],
                                    selectedFamiliars[l],
                                    selectedFamiliars[m],
                                    selectedFamiliars[n]
                                ];
                                let { score, totalPenetration, totalResistance, totalDamageReduction, totalDamageIncrease } = calculateScore(combination);
                                
                                if (score > maxScore) {
                                    maxScore = score;
                                    bestCombination = combination;
                                }
                            }
                        }
                    }
                }
            }
        }

        // 세력과 등급을 정리하기 위한 함수
        function getCount(items) {
            const counts = {};
            items.forEach(item => {
                counts[item] = (counts[item] || 0) + 1;
            });
            return counts;
        }

        // 세력과 등급 값 추출
        const influences = bestCombination.map(f => f.influence);
        const grades = bestCombination.map(f => f.grade);

        // 세력과 등급을 정리
        const influenceCount = getCount(influences);
        const gradeCount = getCount(grades);

        // 세력과 등급을 출력 형식에 맞게 변환
        const influenceText = Object.keys(influenceCount)
            .map(key => `${influenceCount[key]}${key}`)
            .join(' ');
        const gradeText = Object.keys(gradeCount)
            .map(key => `${gradeCount[key]}${key}`)
            .join(' ');

        // 최종 점수 계산
        const { totalPenetration, totalResistance, totalDamageReduction, totalDamageIncrease } = calculateScore(bestCombination);

        // 결과 출력
        const resultDiv = document.getElementById('result');
        resultDiv.innerHTML = `
            최고 점수 조합: ${maxScore}<br>
            ${bestCombination.map(f => `<img src="images/ic_${f.ic}.jpg" class="familiar-image" alt="${f.name}" title="${f.name}">`).join('')}
            <br>세력: ${influenceText}
            <br>등급: ${gradeText}
            <br>피해저항관통: ${totalPenetration}
            <br>피해저항: ${totalResistance}
            <br>대인피해%: ${totalDamageIncrease}
            <br>대인방어%: ${totalDamageReduction}
        `;
    });



    </script>

</body>
</html>
