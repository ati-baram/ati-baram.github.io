<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>바람의나라: 연 캐릭터 조회</title>
    <script>
        async function fetchOCID() {
            const characterName = document.getElementById("characterName").value;
            const serverName = document.getElementById("serverName").value;

            if (!characterName || !serverName) {
                alert("캐릭터명과 서버명을 입력하세요.");
                return;
            }

            const apiKey = "test_f1df2d99b1e14e205493879cae9b176db3420a00c4bfddb543475cd58d231840efe8d04e6d233bd35cf2fabdeb93fb0d";
            const ocidUrl = `https://open.api.nexon.com/baramy/v1/id?character_name=${encodeURIComponent(characterName)}&server_name=${encodeURIComponent(serverName)}`;

            try {
                const response = await fetch(ocidUrl, {
                    method: "GET",
                    headers: {
                        "accept": "application/json",
                        "x-nxopen-api-key": apiKey
                    }
                });

                // API 응답 확인 (콘솔 출력)
                console.log("OCID API 응답 상태 코드:", response.status);
                const responseText = await response.text();
                console.log("OCID API 응답 본문:", responseText);

                if (!response.ok) {
                    throw new Error(`OCID 조회 실패: ${response.status}`);
                }

                const data = JSON.parse(responseText); // JSON 응답 파싱
                if (!data.ocid) {
                    alert("OCID를 찾을 수 없습니다. 캐릭터명과 서버명을 확인하세요.");
                    return;
                }

                fetchCharacterInfo(data.ocid);
            } catch (error) {
                console.error("OCID 조회 오류:", error);
                alert("캐릭터의 OCID를 불러오는데 실패했습니다.");
            }
        }


        async function fetchCharacterInfo(ocid) {
            const apiKey = "test_f1df2d99b1e14e205493879cae9b176db3420a00c4bfddb543475cd58d231840efe8d04e6d233bd35cf2fabdeb93fb0d";
            const characterUrl = `https://open.api.nexon.com/baramy/v1/character/basic?ocid=${ocid}`;

            try {
                const response = await fetch(characterUrl, {
                    method: "GET",
                    headers: {
                        "accept": "application/json",
                        "x-nxopen-api-key": apiKey
                    }
                });

                if (!response.ok) {
                    throw new Error(`캐릭터 정보 조회 실패: ${response.status}`);
                }

                const data = await response.json();
                displayCharacterData(data);
            } catch (error) {
                console.error("캐릭터 정보 조회 오류:", error);
                alert("캐릭터 정보를 불러오는데 실패했습니다.");
            }
        }

        function displayCharacterData(data, serverDate) {
            // 서버에서 받은 시간이 없으면 현재 시간 사용
            const gmtTime = serverDate ? new Date(serverDate) : new Date();

            // 한국 시간(KST)으로 변환
            const kstTime = new Date(gmtTime.getTime() + 9 * 60 * 60 * 1000); // GMT+9 (KST)

            // 한국 시간 포맷 변경
            const year = kstTime.getFullYear();
            const month = String(kstTime.getMonth() + 1).padStart(2, '0'); // 월 (01~12)
            const day = String(kstTime.getDate()).padStart(2, '0'); // 일 (01~31)
            const hours = kstTime.getHours();
            const minutes = String(kstTime.getMinutes()).padStart(2, '0');
            const seconds = String(kstTime.getSeconds()).padStart(2, '0');
            
            // 오전/오후 구분
            const period = hours >= 12 ? "오후" : "오전";
            const formattedHours = hours % 12 || 12; // 12시간 형식 (0시는 12로 변경)

            const formattedKST = `${year}/${month}/${day} ${period} ${formattedHours}:${minutes}:${seconds} (KST)`;

            const resultDiv = document.getElementById("result");
            resultDiv.innerHTML = `
                <h3>캐릭터 정보</h3>
                <p><strong>닉네임 :</strong> ${data.character_name}</p>
                <p><strong>서버 :</strong> ${data.server_name}</p>
                <p><strong>레벨 :</strong> ${data.character_level}</p>
                <p><strong>경험치 :</strong> ${data.character_exp.toLocaleString()} EXP</p>
                <p><strong>직업 :</strong> ${data.character_class_group_name} (${data.character_class_name})</p>
                <p><strong>국가 :</strong> ${data.character_nation}</p>
                <p><strong>성별 :</strong> ${data.character_gender}</p>
                <p><strong>캐릭터 생성일 :</strong> ${new Date(data.character_date_create).toLocaleDateString()}</p>
                <hr>
                <p><strong>서버 응답 시간 :</strong> ${formattedKST}</p>
            `;
        }



    </script>
</head>
<body>
    <h2>바람의나라: 연 캐릭터 조회</h2>
    <input type="text" id="characterName" placeholder="캐릭터명 입력">
    <select id="serverName">
        <option value="">서버 선택</option>
        <option value="연">연</option>
        <option value="해명">해명</option>
        <option value="무휼">무휼</option>
        <option value="세류">세류</option>
    </select>
    <button onclick="fetchOCID()">조회</button>
    <div id="result"></div>
</body>
</html>
