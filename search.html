<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>바람의나라: 연 캐릭터 조회</title>
    <script>
        async function fetchOCID() {
            const characterName = document.getElementById("characterName").value;
            const serverName = document.getElementById("serverName").value;

            if (!characterName || !serverName) {
                alert("캐릭터명과 서버명을 입력하세요.");
                return;
            }

            const apiKey = "test_f1df2d99b1e14e205493879cae9b176db3420a00c4bfddb543475cd58d231840efe8d04e6d233bd35cf2fabdeb93fb0d";
            const ocidUrl = `https://open.api.nexon.com/baramy/v1/id?character_name=${encodeURIComponent(characterName)}&server_name=${encodeURIComponent(serverName)}`;

            try {
                const response = await fetch(ocidUrl, {
                    method: "GET",
                    headers: {
                        "accept": "application/json",
                        "x-nxopen-api-key": apiKey
                    }
                });

                // API 응답 확인 (콘솔 출력)
                console.log("OCID API 응답 상태 코드:", response.status);
                const responseText = await response.text();
                console.log("OCID API 응답 본문:", responseText);

                if (!response.ok) {
                    throw new Error(`OCID 조회 실패: ${response.status}`);
                }

                const data = JSON.parse(responseText); // JSON 응답 파싱
                if (!data.ocid) {
                    alert("OCID를 찾을 수 없습니다. 캐릭터명과 서버명을 확인하세요.");
                    return;
                }

                fetchCharacterInfo(data.ocid);
            } catch (error) {
                console.error("OCID 조회 오류:", error);
                alert("캐릭터의 OCID를 불러오는데 실패했습니다.");
            }
        }



        async function fetchCharacterInfo(ocid) {
            const apiKey = "test_f1df2d99b1e14e205493879cae9b176db3420a00c4bfddb543475cd58d231840efe8d04e6d233bd35cf2fabdeb93fb0d";
            const characterUrl = `https://open.api.nexon.com/baramy/v1/character/basic?ocid=${ocid}`;

            try {
                const response = await fetch(characterUrl, {
                    method: "GET",
                    headers: {
                        "accept": "application/json",
                        "x-nxopen-api-key": apiKey
                    }
                });

                if (!response.ok) {
                    throw new Error(`캐릭터 정보 조회 실패: ${response.status}`);
                }

                const data = await response.json();
                const serverDate = response.headers.get("date"); // 서버에서 응답한 시간

                // 추가로 칭호 정보도 가져오기
                const titleEquipment = await fetchTitleEquipment(ocid);

                displayCharacterData(data, serverDate, titleEquipment);
            } catch (error) {
                console.error("캐릭터 정보 조회 오류:", error);
                alert("캐릭터 정보를 불러오는데 실패했습니다.");
            }
        }


        async function fetchTitleEquipment(ocid) {
            const apiKey = "test_f1df2d99b1e14e205493879cae9b176db3420a00c4bfddb543475cd58d231840efe8d04e6d233bd35cf2fabdeb93fb0d";
            const titleUrl = `https://open.api.nexon.com/baramy/v1/character/title-equipment?ocid=${ocid}`;

            try {
                const response = await fetch(titleUrl, {
                    method: "GET",
                    headers: {
                        "accept": "application/json",
                        "x-nxopen-api-key": apiKey
                    }
                });

                if (!response.ok) {
                    throw new Error(`칭호 정보 조회 실패: ${response.status}`);
                }

                const data = await response.json();
                return data.title_equipment; // 칭호 정보 배열 반환
            } catch (error) {
                console.error("칭호 정보 조회 오류:", error);
                return null;
            }
        }



        function displayCharacterData(data, serverDate, titleEquipment) {
            let formattedKST;

            if (serverDate) {
                try {
                    const gmtTime = new Date(serverDate);
                    if (isNaN(gmtTime.getTime())) throw new Error("Invalid Date");

                    const kstTime = new Date(gmtTime.getTime() + 9 * 60 * 60 * 1000); // GMT+9 (KST)
                    const year = kstTime.getUTCFullYear();
                    const month = String(kstTime.getUTCMonth() + 1).padStart(2, '0');
                    const day = String(kstTime.getUTCDate()).padStart(2, '0');
                    const hours = String(kstTime.getUTCHours()).padStart(2, '0');
                    const minutes = String(kstTime.getUTCMinutes()).padStart(2, '0');
                    const seconds = String(kstTime.getUTCSeconds()).padStart(2, '0');

                    formattedKST = `${year}-${month}-${day} ${hours}:${minutes}:${seconds} KST`;
                } catch (error) {
                    console.error("서버 응답 시간 변환 오류:", error);
                    formattedKST = "서버 응답 시간 오류";
                }
            } else {
                formattedKST = "서버 응답 시간 없음";
            }

            // 칭호 목록 분류
            let equippedTitles = [];
            let displayedTitles = [];

            if (titleEquipment && titleEquipment.length > 0) {
                titleEquipment.forEach(title => {
                    const type = title.title_equipment_type === "1" ? "장착 칭호" : "표시 칭호";
                    if (title.title_equipment_type === "1") {
                        equippedTitles.push(`[${type}] ${title.title_type_name} - ${title.title_name}`);
                    } else {
                        displayedTitles.push(`[${type}] ${title.title_type_name} - ${title.title_name}`);
                    }
                });
            }

            // 칭호 HTML 생성
            let titleHtml = "<h3>칭호 정보</h3>";
            if (equippedTitles.length > 0) {
                titleHtml += "<h4>장착 칭호</h4><ul>";
                equippedTitles.forEach(title => {
                    titleHtml += `<li>${title}</li>`;
                });
                titleHtml += "</ul>";
            }
            if (displayedTitles.length > 0) {
                titleHtml += "<h4>표시 칭호</h4><ul>";
                displayedTitles.forEach(title => {
                    titleHtml += `<li>${title}</li>`;
                });
                titleHtml += "</ul>";
            }
            if (equippedTitles.length === 0 && displayedTitles.length === 0) {
                titleHtml += "<p>장착된 칭호 없음</p>";
            }

            // 결과 표시
            const resultDiv = document.getElementById("result");
            resultDiv.innerHTML = `
                <h3>캐릭터 정보</h3>
                <p><strong>닉네임 :</strong> ${data.character_name}</p>
                <p><strong>서버 :</strong> ${data.server_name}</p>
                <p><strong>레벨 :</strong> ${data.character_level}</p>
                <p><strong>경험치 :</strong> ${data.character_exp.toLocaleString()} EXP</p>
                <p><strong>직업 :</strong> ${data.character_class_group_name} (${data.character_class_name})</p>
                <p><strong>국가 :</strong> ${data.character_nation}</p>
                <p><strong>성별 :</strong> ${data.character_gender}</p>
                <p><strong>캐릭터 생성일 :</strong> ${new Date(data.character_date_create).toLocaleDateString()}</p>
                <hr>
                <p><strong>서버 응답 시간 :</strong> ${formattedKST}</p>
                <hr>
                ${titleHtml}
            `;
        }



    </script>
</head>
<body>
    <h2>바람의나라: 연 캐릭터 조회</h2>
    <input type="text" id="characterName" placeholder="캐릭터명 입력">
    <select id="serverName">
        <option value="">서버 선택</option>
        <option value="연">연</option>
        <option value="해명">해명</option>
        <option value="무휼">무휼</option>
        <option value="세류">세류</option>
    </select>
    <button onclick="fetchOCID()">조회</button>
    <div id="result"></div>
</body>
</html>
