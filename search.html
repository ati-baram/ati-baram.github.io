<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>캐릭터 조회</title>
    <script>
        const apiKey = "test_f1df2d99b1e14e205493879cae9b176db3420a00c4bfddb543475cd58d231840efe8d04e6d233bd35cf2fabdeb93fb0d";
        // const apiKey = "test_c0115d4000b9041e99c825b2f73ad1cd6af9479e0fbba2f6db93f87c1dd2ef51efe8d04e6d233bd35cf2fabdeb93fb0d"; // 아리샨
        const servers = ["연", "해명", "세류", "무휼"];

        async function fetchOCID() {
            const characterName = document.getElementById("characterName").value.trim();

            if (!characterName) {
                alert("캐릭터명을 입력하세요.");
                return;
            }

            try {
                const ocidRequests = servers.map(server =>
                    fetch(`https://open.api.nexon.com/baramy/v1/id?character_name=${encodeURIComponent(characterName)}&server_name=${encodeURIComponent(server)}`, {
                        method: "GET",
                        headers: {
                            "accept": "application/json",
                            "x-nxopen-api-key": apiKey
                        }
                    }).then(response => response.ok ? response.json() : null)
                );

                const ocidResults = await Promise.all(ocidRequests);
                const validResults = ocidResults.filter(data => data && data.ocid);

                if (validResults.length === 0) {
                    alert("OCID를 찾을 수 없습니다. 캐릭터명을 확인하세요.");
                    return;
                }

                // 가장 높은 레벨의 캐릭터 찾기
                const characterInfos = await Promise.all(validResults.map(async data => {
                    const characterData = await fetchCharacterInfo(data.ocid);
                    return { ...characterData, ocid: data.ocid };
                }));

                const highestLevelCharacter = characterInfos.reduce((max, char) => (char.character_level > max.character_level ? char : max), characterInfos[0]);

                if (highestLevelCharacter) {
                    const titleEquipment = await fetchTitleEquipment(highestLevelCharacter.ocid);
                    displayCharacterData(highestLevelCharacter, titleEquipment);
                }
            } catch (error) {
                console.error("OCID 조회 오류:", error);
                alert("캐릭터 정보를 불러오는데 실패했습니다.");
            }
        }

        async function fetchCharacterInfo(ocid) {
            try {
                const response = await fetch(`https://open.api.nexon.com/baramy/v1/character/basic?ocid=${ocid}`, {
                    method: "GET",
                    headers: {
                        "accept": "application/json",
                        "x-nxopen-api-key": apiKey
                    }
                });

                if (!response.ok) {
                    throw new Error(`캐릭터 정보 조회 실패: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error("캐릭터 정보 조회 오류:", error);
                return null;
            }
        }

        async function fetchTitleEquipment(ocid) {
            try {
                const response = await fetch(`https://open.api.nexon.com/baramy/v1/character/title-equipment?ocid=${ocid}`, {
                    method: "GET",
                    headers: {
                        "accept": "application/json",
                        "x-nxopen-api-key": apiKey
                    }
                });

                if (!response.ok) {
                    throw new Error(`칭호 정보 조회 실패: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error("칭호 정보 조회 오류:", error);
                return null;
            }
        }

        function displayCharacterData(data, titleEquipment) {
            let titleHtml = "<h3>칭호</h3>";
            
            if (titleEquipment && titleEquipment.title_equipment.length > 0) {
                const equippedTitles = titleEquipment.title_equipment
                    .filter(title => title.title_equipment_type === "1") // 장착 칭호만 필터링
                    .map(title => `<li>${title.title_type_name} - ${title.title_name}</li>`);

                if (equippedTitles.length > 0) {
                    titleHtml += "<ul>" + equippedTitles.join('') + "</ul>";
                } else {
                    titleHtml += "<p>장착된 칭호 없음</p>";
                }
            } else {
                titleHtml += "<p>장착된 칭호 없음</p>";
            }

            document.getElementById("result").innerHTML = `
                <h3>캐릭터 정보</h3>
                <p><strong>닉네임 :</strong> ${data.character_name}</p>
                <p><strong>서버 :</strong> ${data.server_name}</p>
                <p><strong>레벨 :</strong> ${data.character_level}</p>
                <p><strong>직업 :</strong> ${data.character_class_group_name} (${data.character_class_name})</p>
                <p><strong>경험치 :</strong> ${data.character_exp.toLocaleString()} EXP</p>
                <p><strong>캐릭터 생성일 :</strong> ${new Date(data.character_date_create).toLocaleDateString()}</p>
                <hr>
                ${titleHtml}
            `;
        }

    </script>
</head>
<body>
    <h2>캐릭터 조회</h2>
    <input type="text" id="characterName" placeholder="캐릭터명 입력">
    <button onclick="fetchOCID()">조회</button>
    <div id="result"></div>
</body>
</html>
