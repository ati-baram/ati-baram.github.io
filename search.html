<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>캐릭터 조회 & 추적</title>
    <style>
        body { font-family: Arial, sans-serif; }
        
        /* 전체 레이아웃 설정 */
        .container {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            max-width: 1200px;
            margin: auto;
            gap: 20px;
        }

        /* 왼쪽 캐릭터 조회 영역 */
        .search-section {
            width: 45%;
        }

        /* 오른쪽 예의주시 목록 */
        .tracking-section {
            width: 50%;
        }

        /* 캐릭터 카드 스타일 */
        .character-card {
            border: 1px solid #ccc; 
            padding: 10px; 
            margin: 5px; 
            border-radius: 5px;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            width: 100%;
        }

        .character-list {
            display: flex; 
            flex-wrap: wrap; 
            gap: 10px; 
            margin-top: 10px;
        }

        .option-group { margin-top: 5px; }
        .result { margin-top: 10px; font-size: 14px; }
        button { margin-top: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h2>캐릭터 조회 & 추적</h2>

    <div class="container">
        <!-- 왼쪽: 캐릭터 검색 -->
        <div class="search-section">
            <h3>캐릭터 조회</h3>
            <input type="text" id="characterName" placeholder="캐릭터명 입력">
            <button onclick="fetchOCID()">조회</button>
            <div id="result"></div>
        </div>

        <!-- 오른쪽: 예의주시하는 캐릭터 -->
        <div class="tracking-section">
            <h3>예의주시</h3>
            <input type="text" id="trackingCharacterName" placeholder="캐릭터명 입력">
            <button onclick="addCharacter()">등록</button>
            <div class="character-list" id="characterList"></div>
        </div>
    </div>

    <script>
        const apiKey = "test_f1df2d99b1e14e205493879cae9b176db3420a00c4bfddb543475cd58d231840efe8d04e6d233bd35cf2fabdeb93fb0d";
        const servers = ["연", "해명", "세류", "무휼"];
        let trackingIntervals = {};

        async function fetchOCID() {
            const characterName = document.getElementById("characterName").value.trim();
            if (!characterName) {
                alert("캐릭터명을 입력하세요.");
                return;
            }

            try {
                document.getElementById("result").innerText = `🔍 ${characterName} 검색 중...`;

                const ocidRequests = servers.map(server =>
                    fetch(`https://open.api.nexon.com/baramy/v1/id?character_name=${encodeURIComponent(characterName)}&server_name=${encodeURIComponent(server)}`, {
                        method: "GET",
                        headers: { "accept": "application/json", "x-nxopen-api-key": apiKey }
                    }).then(response => response.ok ? response.json() : null)
                );

                const ocidResults = await Promise.all(ocidRequests);
                const validResults = ocidResults.filter(data => data && data.ocid);
                if (validResults.length === 0) {
                    document.getElementById("result").innerText = "캐릭터 정보를 찾을 수 없습니다.";
                    return;
                }

                const characterInfos = await Promise.all(validResults.map(async data => {
                    const { characterData, serverDate } = await fetchCharacterInfo(data.ocid);
                    const titleEquipment = await fetchTitleEquipment(data.ocid);
                    return { ...characterData, ocid: data.ocid, serverDate, titleEquipment };
                }));

                const highestLevelCharacter = characterInfos.reduce((max, char) => (char.character_level > max.character_level ? char : max), characterInfos[0]);
                displayCharacterData(highestLevelCharacter, "result");
            } catch (error) {
                console.error("OCID 조회 오류:", error);
                alert("캐릭터 정보를 불러오는데 실패했습니다.");
            }
        }

        async function fetchCharacterInfo(ocid) {
            try {
                const response = await fetch(`https://open.api.nexon.com/baramy/v1/character/basic?ocid=${ocid}`, {
                    method: "GET",
                    headers: { "accept": "application/json", "x-nxopen-api-key": apiKey }
                });

                if (!response.ok) {
                    throw new Error(`캐릭터 정보 조회 실패: ${response.status}`);
                }

                const characterData = await response.json();
                const serverDate = response.headers.get("date"); // 서버 응답 시간
                return { characterData, serverDate };
            } catch (error) {
                console.error("캐릭터 정보 조회 오류:", error);
                return { characterData: null, serverDate: null };
            }
        }

        async function fetchTitleEquipment(ocid) {
            try {
                const response = await fetch(`https://open.api.nexon.com/baramy/v1/character/title-equipment?ocid=${ocid}`, {
                    method: "GET",
                    headers: { "accept": "application/json", "x-nxopen-api-key": apiKey }
                });

                if (!response.ok) {
                    throw new Error(`칭호 정보 조회 실패: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error("칭호 정보 조회 오류:", error);
                return null;
            }
        }

        function displayCharacterData(data, cardId) {
            if (!data) {
                document.getElementById(cardId).innerText = "데이터 없음";
                return;
            }

            // 서버 응답 시간 변환 (UTC → KST)
            let formattedKST = "서버 응답 시간 없음";
            if (data.serverDate) {
                try {
                    const gmtTime = new Date(data.serverDate);
                    gmtTime.setHours(gmtTime.getHours() + 9); // UTC → KST 변환
                    formattedKST = gmtTime.toLocaleString("ko-KR", { timeZone: "Asia/Seoul" }) + " KST";
                } catch (error) {
                    console.error("서버 응답 시간 변환 오류:", error);
                }
            }

            // 장착 칭호 필터링
            let titleHtml = "<h3>칭호</h3>";
            const equippedTitles = data.titleEquipment?.title_equipment?.filter(title => title.title_equipment_type === "1") || [];

            if (equippedTitles.length > 0) {
                titleHtml += "<ul>";
                equippedTitles.forEach(title => {
                    titleHtml += `<li>${title.title_type_name} - ${title.title_name}</li>`;
                });
                titleHtml += "</ul>";
            } else {
                titleHtml += "<p>장착된 칭호 없음</p>";
            }

            document.getElementById(cardId).innerHTML = `
                <strong>닉네임:</strong> ${data.character_name}<br>
                <strong>레벨:</strong> ${data.character_level}<br>
                <strong>직업:</strong> ${data.character_class_group_name} (${data.character_class_name})<br>
                <strong>서버:</strong> ${data.server_name}<br>
                <strong>경험치:</strong> ${data.character_exp.toLocaleString()} EXP<br>
                <strong>서버 응답 시간:</strong> ${formattedKST}<br>
                ${titleHtml}
            `;
        }
    </script>
</body>
</html>
