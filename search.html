<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìºë¦­í„° ì¡°íšŒ & ì¶”ì </title>
    <style>
        body { font-family: Arial, sans-serif; }
        
        .container {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            max-width: 1200px;
            margin: auto;
            gap: 20px;
        }

        .search-section {
            width: 45%;
        }

        .tracking-section {
            width: 50%;
        }

        .character-card {
            border: 1px solid #ccc; 
            padding: 10px; 
            margin: 5px; 
            border-radius: 5px;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            width: 100%;
        }

        .character-list {
            display: flex; 
            flex-wrap: wrap; 
            gap: 10px; 
            margin-top: 10px;
        }

        .option-group { margin-top: 5px; }
        .result { margin-top: 10px; font-size: 14px; }
        button { margin-top: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h2>ìºë¦­í„° ì¡°íšŒ & ì¶”ì </h2>

    <div class="container">
        <div class="search-section">
            <h3>ìºë¦­í„° ì¡°íšŒ</h3>
            <input type="text" id="characterName" placeholder="ìºë¦­í„°ëª… ì…ë ¥">
            <button onclick="fetchOCID()">ì¡°íšŒ</button>
            <div id="result"></div>
        </div>

        <div class="tracking-section">
            <h3>ì˜ˆì˜ì£¼ì‹œ</h3>
            <input type="text" id="trackingCharacterName" placeholder="ìºë¦­í„°ëª… ì…ë ¥">
            <button onclick="addCharacter()">ë“±ë¡</button>
            <div class="character-list" id="characterList"></div>
        </div>
    </div>

    <script>
        const apiKey = "test_f1df2d99b1e14e205493879cae9b176db3420a00c4bfddb543475cd58d231840efe8d04e6d233bd35cf2fabdeb93fb0d";
        const servers = ["ì—°", "í•´ëª…", "ì„¸ë¥˜", "ë¬´íœ¼"];
        let trackingIntervals = {};

        async function fetchOCID() {
            const characterName = document.getElementById("characterName").value.trim();
            if (!characterName) {
                alert("ìºë¦­í„°ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.");
                return;
            }

            try {
                document.getElementById("result").innerText = `ğŸ” ${characterName} ê²€ìƒ‰ ì¤‘...`;

                const ocid = await getOCID(characterName);
                if (!ocid) {
                    document.getElementById("result").innerText = "ìºë¦­í„° ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                    return;
                }

                const { characterData, serverDate } = await fetchCharacterInfo(ocid);
                displayCharacterData(characterData, "result", serverDate);
            } catch (error) {
                console.error("OCID ì¡°íšŒ ì˜¤ë¥˜:", error);
                alert("ìºë¦­í„° ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        }

        async function getOCID(characterName) {
            for (const server of servers) {
                try {
                    const response = await fetch(`https://open.api.nexon.com/baramy/v1/id?character_name=${encodeURIComponent(characterName)}&server_name=${encodeURIComponent(server)}`, {
                        method: "GET",
                        headers: { "accept": "application/json", "x-nxopen-api-key": apiKey }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.ocid) return data.ocid;
                    }
                } catch (error) {
                    console.error("OCID ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:", error);
                }
            }
            return null;
        }

        async function fetchCharacterInfo(ocid) {
            try {
                const response = await fetch(`https://open.api.nexon.com/baramy/v1/character/basic?ocid=${ocid}`, {
                    method: "GET",
                    headers: { "accept": "application/json", "x-nxopen-api-key": apiKey }
                });

                if (!response.ok) {
                    throw new Error(`ìºë¦­í„° ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨: ${response.status}`);
                }

                const characterData = await response.json();
                const serverDate = response.headers.get("date"); // ì„œë²„ ì‘ë‹µ ì‹œê°„
                return { characterData, serverDate };
            } catch (error) {
                console.error("ìºë¦­í„° ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:", error);
                return { characterData: null, serverDate: null };
            }
        }

        function displayCharacterData(data, elementId, serverDate) {
            if (!data) {
                document.getElementById(elementId).innerText = "ë°ì´í„° ì—†ìŒ";
                return;
            }

            let formattedKST = "ì„œë²„ ì‘ë‹µ ì‹œê°„ ì—†ìŒ";
            if (serverDate) {
                try {
                    const gmtTime = new Date(serverDate);
                    gmtTime.setHours(gmtTime.getHours() + 9);
                    formattedKST = gmtTime.toLocaleString("ko-KR", { timeZone: "Asia/Seoul" }) + " KST";
                } catch (error) {
                    console.error("ì„œë²„ ì‘ë‹µ ì‹œê°„ ë³€í™˜ ì˜¤ë¥˜:", error);
                }
            }

            document.getElementById(elementId).innerHTML = `
                <strong>ë‹‰ë„¤ì„:</strong> ${data.character_name}<br>
                <strong>ë ˆë²¨:</strong> ${data.character_level}<br>
                <strong>ì§ì—…:</strong> ${data.character_class_group_name} (${data.character_class_name})<br>
                <strong>ì„œë²„:</strong> ${data.server_name}<br>
                <strong>ê²½í—˜ì¹˜:</strong> ${data.character_exp.toLocaleString()} EXP<br>
                <strong>ì„œë²„ ì‘ë‹µ ì‹œê°„:</strong> ${formattedKST}<br>
            `;
        }

        function startTracking(characterName, cardId) {
            stopTracking(cardId);
            const selectedInterval = document.querySelector(`input[name="interval-${cardId}"]:checked`);
            if (!selectedInterval) {
                alert("ì¡°íšŒ ì£¼ê¸°ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
                return;
            }

            const intervalTime = parseInt(selectedInterval.value, 10);
            trackingIntervals[cardId] = setInterval(async () => {
                const ocid = await getOCID(characterName);
                if (ocid) {
                    const { characterData, serverDate } = await fetchCharacterInfo(ocid);
                    displayCharacterData(characterData, `result-${cardId}`, serverDate);
                } else {
                    document.getElementById(`result-${cardId}`).innerText = "ìºë¦­í„° ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                }
            }, intervalTime);

            alert(`${characterName}ì˜ ì •ë³´ë¥¼ ${intervalTime / 1000}ì´ˆë§ˆë‹¤ ì¡°íšŒí•©ë‹ˆë‹¤.`);
        }

        function stopTracking(cardId) {
            if (trackingIntervals[cardId]) {
                clearInterval(trackingIntervals[cardId]);
                delete trackingIntervals[cardId];
            }
        }
    </script>
</body>
</html>
